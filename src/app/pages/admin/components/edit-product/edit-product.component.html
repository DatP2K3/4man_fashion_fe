<p-toast position="top-right" [baseZIndex]="9999"></p-toast>

<div class="add-product-container">
  <h1>Thêm sản phẩm mới</h1>

  <div class="product-form">
    <!-- Left sidebar with sections -->
    <div class="sidebar">
      <div
        class="nav-section"
        [class.active]="currentSection === 'basic'"
        (click)="scrollToSection('basic')"
      >
        <span>Thông tin cơ bản</span>
      </div>

      <div
        class="nav-section"
        [class.active]="currentSection === 'details'"
        (click)="scrollToSection('details')"
      >
        <span>Chi tiết sản phẩm</span>
      </div>

      <div
        class="nav-section"
        [class.active]="currentSection === 'sales'"
        (click)="scrollToSection('sales')"
      >
        <span>Thông tin bán hàng</span>
      </div>

      <div
        class="nav-section"
        [class.active]="currentSection === 'shipping'"
        (click)="scrollToSection('shipping')"
      >
        <span>Vận chuyển</span>
      </div>
    </div>

    <!-- Main form content -->
    <div class="main-content">
      <form
        *ngIf="productForm"
        [formGroup]="productForm"
        (ngSubmit)="onSubmit()"
      >
        <!-- Basic Information Section -->
        <div id="basic" class="section">
          <div class="section-header">Thông tin cơ bản</div>

          <!-- Product Images -->
          <div class="form-group required">
            <label>Hình ảnh sản phẩm</label>
            <div class="image-upload-container">
              <div class="main-image-upload" (click)="selectImageView('main')">
                <div
                  *ngIf="!imagePreviewUrls['main']"
                  class="upload-placeholder"
                >
                  <i class="pi pi-image"></i>
                  <span>Tải lên ảnh chính</span>
                  <p>Kích thước: 600 × 600 px.</p>
                  <p>Kích thước tập tin tối đa: 5 MB.</p>
                  <p>Định dạng: JPG, JPEG, PNG.</p>
                </div>
                <img
                  *ngIf="imagePreviewUrls['main']"
                  [src]="imagePreviewUrls['main']"
                  alt="Main product image"
                  class="preview-image"
                />
              </div>

              <div class="image-options">
                <div class="image-option" (click)="selectImageView('front')">
                  <div *ngIf="!imagePreviewUrls['front']" class="option-icon">
                    <i class="pi pi-image"></i>
                  </div>
                  <img
                    *ngIf="imagePreviewUrls['front']"
                    [src]="imagePreviewUrls['front']"
                    alt="Front view"
                    class="option-preview"
                  />
                  <span>Chính diện</span>
                </div>
                <div class="image-option" (click)="selectImageView('side')">
                  <div *ngIf="!imagePreviewUrls['side']" class="option-icon">
                    <i class="pi pi-image"></i>
                  </div>
                  <img
                    *ngIf="imagePreviewUrls['side']"
                    [src]="imagePreviewUrls['side']"
                    alt="Side view"
                    class="option-preview"
                  />
                  <span>Cạnh bên</span>
                </div>
                <div class="image-option" (click)="selectImageView('angles')">
                  <div *ngIf="!imagePreviewUrls['angles']" class="option-icon">
                    <i class="pi pi-image"></i>
                  </div>
                  <img
                    *ngIf="imagePreviewUrls['angles']"
                    [src]="imagePreviewUrls['angles']"
                    alt="Other angles"
                    class="option-preview"
                  />
                  <span>Các góc độ khác</span>
                </div>
                <div class="image-option" (click)="selectImageView('using')">
                  <div *ngIf="!imagePreviewUrls['using']" class="option-icon">
                    <i class="pi pi-image"></i>
                  </div>
                  <img
                    *ngIf="imagePreviewUrls['using']"
                    [src]="imagePreviewUrls['using']"
                    alt="In use"
                    class="option-preview"
                  />
                  <span>Đang sử dụng</span>
                </div>
              </div>

              <div class="additional-image-options">
                <div class="image-option" (click)="selectImageView('variant')">
                  <div *ngIf="!imagePreviewUrls['variant']" class="option-icon">
                    <i class="pi pi-image"></i>
                  </div>
                  <img
                    *ngIf="imagePreviewUrls['variant']"
                    [src]="imagePreviewUrls['variant']"
                    alt="Variant"
                    class="option-preview"
                  />
                  <span>Biến thể</span>
                </div>
                <div class="image-option" (click)="selectImageView('back')">
                  <div *ngIf="!imagePreviewUrls['back']" class="option-icon">
                    <i class="pi pi-image"></i>
                  </div>
                  <img
                    *ngIf="imagePreviewUrls['back']"
                    [src]="imagePreviewUrls['back']"
                    alt="Background"
                    class="option-preview"
                  />
                  <span>Phối cảnh nền</span>
                </div>
                <div class="image-option" (click)="selectImageView('detail')">
                  <div *ngIf="!imagePreviewUrls['detail']" class="option-icon">
                    <i class="pi pi-image"></i>
                  </div>
                  <img
                    *ngIf="imagePreviewUrls['detail']"
                    [src]="imagePreviewUrls['detail']"
                    alt="Detail"
                    class="option-preview"
                  />
                  <span>Ảnh chụp cận</span>
                </div>
                <div class="image-option" (click)="selectImageView('size')">
                  <div *ngIf="!imagePreviewUrls['size']" class="option-icon">
                    <i class="pi pi-image"></i>
                  </div>
                  <img
                    *ngIf="imagePreviewUrls['size']"
                    [src]="imagePreviewUrls['size']"
                    alt="Size"
                    class="option-preview"
                  />
                  <span>Kích thước</span>
                </div>
              </div>
              <input
                type="file"
                #fileInput
                hidden
                accept="image/jpeg,image/jpg,image/png"
                (change)="onFileSelected($event)"
              />
            </div>
            <div *ngIf="formErrors.images" class="error-message">
              {{ formErrors.images }}
            </div>
          </div>

          <!-- Product Name -->
          <div class="form-group required">
            <label for="productName">Tên sản phẩm</label>
            <div class="name-input-container">
              <input
                id="productName"
                type="text"
                formControlName="name"
                placeholder="[Thương hiệu] + [Nội dung] + [Phạm vi áp dụng] + [Loại sản phẩm] + [Chức năng / Tính năng chính]"
                pInputText
                [maxLength]="255"
              />
              <span class="char-count"
                >{{ productForm.get("name")?.value?.length || 0 }}/255</span
              >
            </div>
            <div
              *ngIf="formSubmitted && productForm?.get('name')?.errors"
              class="error-message"
            >
              <span *ngIf="productForm.get('name')?.errors?.['required']"
                >Tên sản phẩm là bắt buộc</span
              >
            </div>
          </div>

          <!-- Category -->
          <div class="form-group required">
            <label for="category">Hạng mục</label>
            <div class="category-selection">
              <p-dropdown
                formControlName="categoryId"
                [options]="categories"
                optionLabel="name"
                optionValue="id"
                placeholder="Vui lòng chọn một hạng mục"
                [filter]="true"
                filterBy="name"
                [showClear]="true"
                (onChange)="onCategoryChange($event)"
              ></p-dropdown>
            </div>
            <div
              *ngIf="formSubmitted && productForm?.get('categoryId')?.errors"
              class="error-message"
            >
              <span *ngIf="productForm?.get('categoryId')?.errors?.['required']"
                >Hạng mục là bắt buộc</span
              >
            </div>
          </div>
        </div>

        <!-- Product Details Section -->
        <div id="details" class="section">
          <div class="section-header">Chi tiết sản phẩm</div>

          <!-- Product Technical Specifications from tag_descriptions -->
          <div
            class="form-group"
            *ngIf="descriptionKeys && descriptionKeys.length > 0"
          >
            <label>Thông số kỹ thuật</label>
            <div class="description-fields">
              <p-card>
                <ng-template pTemplate="header">
                  <div
                    class="flex justify-content-between align-items-center p-3 bg-primary text-white"
                  >
                    <span
                      >Thông số kỹ thuật theo hạng mục "{{
                        getSelectedCategoryName()
                      }}"</span
                    >
                  </div>
                </ng-template>

                <div class="p-fluid p-grid p-formgrid">
                  <div class="p-field mb-3" *ngFor="let key of descriptionKeys">
                    <label [for]="'desc_' + key">{{ key }}</label>
                    <input
                      [id]="'desc_' + key"
                      type="text"
                      pInputText
                      [placeholder]="'Nhập ' + key"
                      [(ngModel)]="descriptionValues[key]"
                      [ngModelOptions]="{ standalone: true }"
                    />
                  </div>
                </div>
              </p-card>
            </div>
          </div>

          <!-- Detailed Product Description -->
          <div class="form-group required">
            <label for="introduce">Mô tả chi tiết sản phẩm</label>
            <div class="description-container">
              <div class="description-ai-container">
                <div class="description-input">
                  <div class="ai-input-container">
                    <input
                      type="text"
                      placeholder="Nhập các từ khóa về lợi ích, tính năng, thương hiệu hoặc nội dung mô tả của sản phẩm."
                      pInputText
                      [(ngModel)]="aiDescriptionKeywords"
                      [ngModelOptions]="{ standalone: true }"
                    />
                    <p-button
                      label="Tạo bằng AI"
                      styleClass="p-button-primary"
                      (click)="generateAIDescription()"
                      [loading]="isGeneratingDescription"
                      [disabled]="isGeneratingDescription"
                    ></p-button>
                  </div>
                </div>

                <p-editor
                  formControlName="introduce"
                  [style]="{ height: '320px' }"
                  placeholder="Nhập mô tả chi tiết sản phẩm"
                >
                  <ng-template pTemplate="header">
                    <span class="ql-formats">
                      <button
                        type="button"
                        class="ql-list"
                        value="ordered"
                      ></button>
                      <button
                        type="button"
                        class="ql-list"
                        value="bullet"
                      ></button>
                      <button type="button" class="ql-align" value=""></button>
                      <button
                        type="button"
                        class="ql-align"
                        value="center"
                      ></button>
                      <button
                        type="button"
                        class="ql-align"
                        value="right"
                      ></button>
                      <button
                        type="button"
                        class="ql-align"
                        value="justify"
                      ></button>
                    </span>
                    <span class="ql-formats">
                      <button type="button" class="ql-bold"></button>
                      <button type="button" class="ql-italic"></button>
                      <button type="button" class="ql-underline"></button>
                    </span>
                    <span class="ql-formats">
                      <button type="button" class="ql-image"></button>
                    </span>
                  </ng-template>
                </p-editor>
              </div>
              <div
                *ngIf="formSubmitted && productForm?.get('introduce')?.errors"
                class="error-message"
              >
                <span
                  *ngIf="productForm?.get('introduce')?.errors?.['required']"
                  >Mô tả sản phẩm là bắt buộc</span
                >
              </div>
            </div>
          </div>
        </div>

        <!-- Sales Information Section -->
        <div id="sales" class="section">
          <div class="section-header">Thông tin bán hàng</div>

          <!-- Price input (always visible) -->
          <div class="form-group required">
            <label for="price">Giá bán lẻ</label>
            <div class="price-input">
              <input
                id="price"
                type="number"
                formControlName="price"
                pInputText
              />
            </div>
            <div
              *ngIf="formSubmitted && productForm?.get('price')?.errors"
              class="error-message"
            >
              <span *ngIf="productForm?.get('price')?.errors?.['required']"
                >Giá bán lẻ là bắt buộc</span
              >
            </div>
          </div>

          <!-- Variants Section (always shown) -->
          <div class="variants-section">
            <!-- Variant Name Input -->
            <div
              class="variant-input"
              *ngFor="let variant of variants; let i = index"
            >
              <div class="variant-header">
                <label>{{ variant.name }}</label>
                <div class="variant-actions">
                  <p-button
                    icon="pi pi-trash"
                    styleClass="p-button-text p-button-danger"
                    (click)="removeVariant(i)"
                  ></p-button>
                </div>
              </div>

              <!-- Variant Options for "Kích cỡ" -->
              <div *ngIf="variant.name === 'Kích cỡ'" class="variant-options">
                <div class="variant-option-input">
                  <input
                    type="text"
                    pInputText
                    placeholder="Nhập một tùy chọn"
                    [(ngModel)]="newSizeOption"
                    [ngModelOptions]="{ standalone: true }"
                    maxlength="50"
                  />
                  <span class="char-count"
                    >{{ newSizeOption.length || 0 }}/50</span
                  >
                  <p-button
                    label="Xong"
                    styleClass="p-button-primary"
                    (click)="addSizeOption()"
                  ></p-button>
                </div>
                <div class="selected-options">
                  <p-chip
                    *ngFor="let option of variant.options; let j = index"
                    [label]="option"
                    [removable]="true"
                    (onRemove)="removeOption(i, j)"
                  ></p-chip>
                </div>
              </div>

              <!-- Variant Options for "màu sắc" -->
              <div *ngIf="variant.name === 'màu sắc'" class="variant-options">
                <div class="variant-option-input">
                  <input
                    type="text"
                    pInputText
                    placeholder="Nhập một tùy chọn"
                    [(ngModel)]="newColorOption"
                    [ngModelOptions]="{ standalone: true }"
                    maxlength="50"
                  />
                  <span class="char-count"
                    >{{ newColorOption.length || 0 }}/50</span
                  >
                  <p-button
                    label="Xong"
                    styleClass="p-button-primary"
                    (click)="addColorOption()"
                  ></p-button>
                </div>
                <div class="selected-options">
                  <p-chip
                    *ngFor="let option of variant.options; let j = index"
                    [label]="option"
                    [removable]="true"
                    (onRemove)="removeOption(i, j)"
                  ></p-chip>
                </div>
              </div>
            </div>

            <!-- Add New Variant Button -->
            <div *ngIf="variants.length < 2" class="add-variant">
              <p-button
                label="+ Thêm biến thể"
                styleClass="p-button-text p-button-primary"
                (click)="showAddVariantDialog()"
              ></p-button>
            </div>

            <!-- Variant Combinations Table -->
            <div
              *ngIf="variantCombinations.length > 0"
              class="variant-combinations"
            >
              <p-table
                [value]="variantCombinations"
                [tableStyle]="{ 'min-width': '50rem' }"
              >
                <ng-template pTemplate="header">
                  <tr>
                    <th *ngFor="let variant of variants">{{ variant.name }}</th>
                    <th>Số lượng</th>
                    <th>SKU người bán</th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-combination let-i="rowIndex">
                  <tr>
                    <td *ngFor="let variant of variants; let j = index">
                      {{ combination[variant.name.toLowerCase()] }}
                    </td>
                    <td>
                      <input
                        type="number"
                        pInputText
                        [(ngModel)]="combination.quantity"
                        [ngModelOptions]="{ standalone: true }"
                      />
                    </td>
                    <td>
                      <input
                        type="text"
                        pInputText
                        [(ngModel)]="combination.sku"
                        [ngModelOptions]="{ standalone: true }"
                      />
                    </td>
                  </tr>
                </ng-template>
              </p-table>
            </div>
          </div>
        </div>

        <!-- Shipping Section -->
        <div id="shipping" class="section">
          <div class="section-header">Vận chuyển</div>

          <!-- Weight -->
          <div class="form-group required">
            <label for="weight">Trọng lượng khi đã đóng gói</label>
            <div class="weight-input">
              <p-dropdown
                formControlName="weightUnit"
                [options]="weightUnits"
                optionLabel="name"
                optionValue="value"
                placeholder="Đơn vị"
              ></p-dropdown>
              <input
                id="weight"
                type="number"
                formControlName="weight"
                pInputText
                placeholder="Nhập trọng lượng sản phẩm"
              />
            </div>
            <div
              *ngIf="formSubmitted && productForm?.get('weight')?.errors"
              class="error-message"
            >
              <span *ngIf="productForm?.get('weight')?.errors?.['required']"
                >Trọng lượng là bắt buộc</span
              >
            </div>
          </div>

          <!-- Dimensions -->
          <div class="form-group">
            <label>Kích thước kiện hàng</label>
            <div class="dimensions-note">
              Đảm bảo trọng lượng và kích thước hộp chính xác vì chúng sẽ được
              sử dụng để tính phí vận chuyển và phương thức vận chuyển.
            </div>
            <div class="dimensions-input">
              <div class="dimension">
                <input
                  type="number"
                  formControlName="length"
                  pInputText
                  placeholder="Chiều dài"
                />
                <span>cm</span>
              </div>

              <div class="dimension">
                <input
                  type="number"
                  formControlName="width"
                  pInputText
                  placeholder="Chiều rộng"
                />
                <span>cm</span>
              </div>

              <div class="dimension">
                <input
                  type="number"
                  formControlName="height"
                  pInputText
                  placeholder="Chiều cao"
                />
                <span>cm</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <p-button
            label="Hủy"
            styleClass="p-button-text"
            (click)="cancel()"
          ></p-button>
          <p-button
            type="submit"
            label="Đăng"
            styleClass="p-button-primary"
          ></p-button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Add Variant Dialog -->
<p-dialog
  [(visible)]="showVariantDialog"
  [style]="{ width: '450px', minHeight: '200px' }"
  header="Chọn loại biến thể"
  [modal]="true"
  [closable]="true"
  [draggable]="false"
  [resizable]="false"
  [closeOnEscape]="true"
  appendTo="body"
>
  <div class="variant-dialog-content">
    <p-dropdown
      [(ngModel)]="selectedVariantType"
      [options]="availableVariantTypes"
      optionLabel="name"
      placeholder="Chọn loại biến thể"
      [style]="{ width: '100%' }"
      appendTo="body"
    ></p-dropdown>
  </div>
  <ng-template pTemplate="footer">
    <button
      pButton
      type="button"
      label="Hủy"
      icon="pi pi-times"
      class="p-button-text"
      (click)="closeVariantDialog()"
    ></button>
    <button
      pButton
      type="button"
      label="Thêm"
      icon="pi pi-check"
      class="p-button-primary"
      [disabled]="!selectedVariantType"
      (click)="addVariant()"
    ></button>
  </ng-template>
</p-dialog>
